## 简单的部署流水线
- 提交构建（分支提交）
- 次级构建
	- 两个并行自动化功能测试集（windows和linux）——自动触发测试用例（**bazel**部署+jenkins自动构建测试用例）
- UAT部署——虚拟一个手工环境并部署
- UAT结果——交给领导审批
- 性能检测——自动化性能测试（根据确定好的故事指标）（goCD内置一大堆测试用例）
- 内部体验——Alpha版本部署到企业内部服务器，交给其他团队试用
- 外部体验——Beta版本发给外部用户体验
- 上传发布——发布到指定服务器供用户下载


- 原则
	-  一次构建，多测试用
	-  与业务解耦
	- 并行化
	- 快速反馈
	- 重要反馈优先

## git bazel jenkins的最佳实践
Git、Bazel和Jenkins可以协同工作，为软件开发提供强大的自动化工作流。以下是一个典型的最佳实践示例，展示这些工具如何协作：

### 1. 版本控制与代码仓库 - Git
- **代码托管**：使用Git作为版本控制系统，将代码托管在如GitHub、GitLab或Bitbucket等平台上。
- **分支策略**：实施分支策略，如Git Flow或Trunk Based Development，以管理特性开发、修复和发布。

### 2. 构建和测试 - Bazel
- **构建系统**：使用Bazel作为构建系统，处理项目的编译、链接和测试。
- **构建配置**：在项目的根目录下创建`WORKSPACE`文件，定义外部依赖。在每个包（目录）中创建`BUILD`文件，定义构建规则。
- **依赖管理**：通过Bazel的依赖声明，自动下载和管理项目依赖。

### 3. 持续集成/持续部署 - Jenkins
- **Jenkins服务器**：设置Jenkins服务器，作为CI/CD的中心节点。
- **Webhooks**：在Git仓库平台上配置Webhooks，以便在代码推送时触发Jenkins构建。
- **构建触发**：Jenkins监听Git仓库，当检测到新的提交时自动触发构建流程。
- **自动化构建**：Jenkins拉取最新代码，调用Bazel执行构建和测试。
- **测试报告**：收集Bazel生成的测试报告，并在Jenkins中展示。
- **代码质量**：集成代码质量工具，如SonarQube，分析代码质量并生成报告。
- **部署**：将构建产物（如二进制文件、容器镜像等）部署到测试或生产环境。
- **通知**：通过邮件、Slack等渠道发送构建和部署状态通知。

### 最佳实践流程：
1. **代码提交**：开发者将更改提交到Git仓库的特定分支。
2. **Webhook触发**：Git平台的Webhook通知Jenkins有新的提交。
3. **Jenkins拉取代码**：Jenkins服务器拉取最新代码。
4. **Bazel构建**：Jenkins调用Bazel进行构建和测试。
5. **测试**：Bazel执行自动化测试，并生成测试报告。
6. **代码质量分析**：Jenkins集成代码质量工具分析代码。
7. **构建物生成**：Bazel生成构建物，如二进制文件或容器镜像。
8. **部署**：Jenkins将构建物部署到测试环境进行进一步验证。
9. **手动触发部署**：在测试通过后，开发者或运维人员可以在Jenkins中手动触发部署到生产环境。
10. **监控与反馈**：监控应用状态，收集反馈，并根据需要触发新的构建流程。

### 注意事项：
- **安全性**：确保Jenkins和Git仓库的安全性，如使用访问令牌、SSH密钥等。
- **权限管理**：合理配置Jenkins的用户权限，确保只有授权用户才能触发部署。
- **构建优化**：利用Bazel的增量构建和并行构建特性，提高构建效率。
- **环境一致性**：确保Jenkins服务器和生产环境的一致性，减少环境差异导致的问题。
- **回滚策略**：制定回滚计划，以便在生产环境出现问题时快速恢复。

通过这种协作方式，团队可以实现高效的自动化工作流，提高开发效率，降低错误率，并快速响应市场变化。
## 部署流水线平台——部署服务化
- 平台架构
- 平台能力
	- 事件可追溯
	- 工具链建设——开源工具拼装 or 自研插件
	- 基础支持项目
		- 亚马逊一天部署23000次
		- 谷歌部署5500次
		- ...
	- 编译管理（**jenkins**）
	- 自动化测试
	- 软件部署管理
	- 基础环境管理
		- 基础环境接收到前端服务请求后，从代码仓库、镜像仓库、软件包仓库获取内容，经过加工后得到所需环境。将其投放到对应集群，并发出通知即可。（**这是Docker在微服务架构的一个典型应用**）

- 制品库
	- 临时软件包、正式软件包、镜像等


- 个人部署流水线
![[default.jpg]]
- 开发者自助工具
	- facebook代码部署可视化平台

- 多组件部署流水线
	- 微服务部署的最佳实践
- [[微服务部署的最佳实践]]


- 不断进化的部署流水线
- [GoCD 整行记（零）：基于 Docker 打造 CI/CD 流水线 - 简书 (jianshu.com)](https://www.jianshu.com/p/3d6c844b45b4)
- [[Jenkins和GoCD]]

## 小结

- 四大部署流水线的基础能力（编译构建、自动化测试、部署管理服务、基础环境服务）
- 部署流水线的使用原则
	- 所有软件包来自受控源——镜像源，代码仓库，软件包库
	- 尽可能一切流程自动化、自助化
	- 立即暂停原则
		- 当部署流水线运行时，某一环节一旦出现问题导致执行失败，团队需要立刻修复。此时不允许对此模块的其他变更