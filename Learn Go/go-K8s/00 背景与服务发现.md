- 后台技术发展史
	- 单机->前后端分离->主从架构->**分库分表,索引优化**->数据库扩容->垂直分表->分布式集群->微服务
	- 前后端分离->分布式应用(负载均衡)->**分布式缓存**(慢查询缓存)->微服务->k8s容器化->云原生/混合云

- 服务端，服务实例，客户端
	- 服务端为保证可伸缩与容错性，会开多个服务实例。由nginx做负载均衡根据客户端负载情况将请求转发给多个实例。
- 服务发现
	- 各个服务间通过**http或rpc接口调用**
	- 以注册中心为核心——服务注册、服务查询、服务检查
	- 注册中心是微服务的“数据库”
- 服务发现模式
	- 客户端发现模式
		- **客户端直接查找服务实例位置**，根据需求与服务实例通信
	- 服务端发现模式
		- 服务端make，**客户端请求负载均衡器或API网关**，由这个中间件转发到服务实例。
- 服务发现实现方案——Zookeeper
	- 目录树组织文件
	- 原子广播保证高可用与一致性
- 服务发现实现方案——Etcd
	- 简单，基于http与json
	- 安全，ssl认证支持
	- 快速，单机1000次写
	- 可信，raft分布式一致性协议
- 服务发现实现方案——file
	- 把服务信息写在文件里，定时更新，随时访问
[[分布式一致性协议]]

- 服务发现——API网关
	- API网关的设计模式：代理模式（七层代理or四层代理）
	- 外观模式：客户端与网关的通信（一般http2,http1，https都用），但网关与服务端通信（一般用性能好的http2，还可以封装一些安全函数，客户端透明）
	- 中介者模式
	- 责任链模式、策略模式
- API网关的基础能力——路由转发，负载均衡
	- 解释http，包装包点，负载均衡
	- **中间件能力**：跨域、授权、监控、负载均衡、熔断、缓存、降级、限流、请求分片与管理、静态响应
[[API接口专讲]]
[[负载均衡算法]]

- API网关的服务容错——**限频、限流、降级、熔断、隔离**
	- 服务实例故障、服务实例没有及时调整能力导致被冲垮，**如何治理？**
![[Pasted image 20240424153506.png]]
- 限频——设置TCP请求超时时间——500ms
- 限流——限制目标请求的最大并发数——比如1000qps
- 熔断——紧急处理
- 降级——比熔断友好些
- 隔离——多个服务，相互拖延，造成大规模问题——所以要隔离

- 限流，限频都可以用基本操作：
- ## 计数器、固定窗口、滑动窗口
- 限频——后端接口最大QPS为10000，如何保护？
	- 计数器——原子递增
	- 计数器固定窗口算法——待转发请求进这个固定计数器，计数器递增
- 限频——如何实现后端接口100次/时，1000次/24时的访问频率控制？
	- 计数器滑动窗口算法——多个计数器，24小时1000且1小时100则用24个大小为100的窗口——越细的窗口控制更准。
- 限流——某个接口并发配额10次/秒，如何实现？用不完的部分如何处理以应对突发流量？
	- 漏桶算法：上大下小，小侧为并发大小。多余请求等待（放队列就行）
	- 令牌桶算法：上大下小，大侧发令牌。有令牌的能过，过后收令牌。令牌数量就是并发大小。（相对动态，令牌可以按一定速率发放，那么并发大小在一个区间内）
[[Hystrix容错库]]


- 降级——**有总比没有好**——缓存里拿旧的，PlanB，**默认值**（404,511之类的）
	- 放弃部分请求：跳过计算量大的、降低质量、提高门槛、反向过滤（本来要用过滤器，直接不用了）、补偿（日志记录，事后补偿）
- 熔断——**暂停**对服务调用
	- 触发条件——500,503相应超过100次
	- 恢复条件——5min后尝试连接10次


- 隔离：降级与熔断是一种隔离
	- 线程池隔离、超时中断、限频限流、降级熔断、注册中心介入（服务端实现的服务发现）


### 上述为一个微服务系统的设计框架：服务发现、请求转发、负载均衡、容错机制

- 为什么是K8s
	- K8s使用Etcd做注册中心，在服务端实现服务发现，向客户端包装一个API网关
	- 有很成熟的包含请求转发，负载均衡，监控告警的包装方案。
	- 是**容器化和上云**的标准组件，通用性好。上述微服务框架不通用
	- **极大提高运维效率**
		- 使用镜像容器启动进行多语言交互
		- 利用**节点**进行运维控制
		- 健康检查，服务自愈，
### 基于指标配置服务的自动扩缩容——解决流量暴增问题

[Go语言十一大主流微服务框架_go微服务框架-CSDN博客](https://blog.csdn.net/qq2942713658/article/details/112721577)

